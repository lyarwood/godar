# Godar

> [!NOTE]
> This project has been generated by various AI agents including Gemini CLI and Cursor. While the code has been tested and reviewed, it should be used with caution.

A command-line tool to monitor overflying aircraft from a Virtual Radar Server with real-time notifications. Filtering is performed server-side for performance and simplicity.

## Features

- üõ©Ô∏è **Real-time aircraft monitoring** from Virtual Radar Server
- üîî **Desktop notifications** for detected aircraft with aircraft images
- üñºÔ∏è **Automatic aircraft image fetching** from Wikimedia Commons
- ‚öôÔ∏è **Flexible configuration** via config file or environment variables
- üöÄ **High performance** with connection pooling and retry logic
- üìä **Structured logging** for monitoring and debugging
- üíæ **Smart image caching** to avoid repeated downloads

## Installation

### Prerequisites

- Go 1.23 or later
- Virtual Radar Server (VRS) instance

### From Source

```bash
git clone https://github.com/lyarwood/godar.git
cd godar
go mod tidy
go build -o godar ./
```

### Using Go Install

Install directly from the repository:

```bash
go install github.com/lyarwood/godar@latest
```

This will install the `godar` binary to your `$GOPATH/bin` directory (or `$GOBIN` if set). Make sure this directory is in your `$PATH`.

### Using Make

```bash
make build
```

## Configuration

Godar supports configuration via environment variables or a YAML config file. See below for details.

### Configuration File

Godar looks for configuration files in the following locations (in order of priority):
1. `./godar.yaml` (current working directory)
2. `~/.config/godar/godar.yaml` (user config directory)
3. `~/godar.yaml` (home directory)

Create a `godar.yaml` file in one of these locations (see `godar.yaml.example` for a template):

```yaml
server:
  url: "http://your-vrs-server:8080/VirtualRadar/AircraftList.json"
  username: "myuser"         # Optional: HTTP Basic Auth username
  password: "mypassword"     # Optional: HTTP Basic Auth password

filters:
  aircraft_type: "A320"
  min_altitude: 10000
  max_altitude: 40000
  military: false
  operator: "British Airways"
  flight_number: ""

location:
  latitude: 51.5074
  longitude: -0.1278
  max_distance: 100.0

monitoring:
  poll_interval: "10s"
  debug: false

notification:
  enabled: true
  duration: "30s"  # How long notifications are displayed (default: 30s)
  notify_on_closer_only: true  # Only notify when aircraft get closer (default: true)
  re_notify_after: "5m"        # Re-notify after this time even if not closer (default: 0s)
  cleanup_interval: "10m"      # How often to clean up old aircraft history (default: 10m)
```

### Environment Variables

All configuration can be set via environment variables with the `GODAR_` prefix:

```bash
export GODAR_SERVER_URL="http://your-vrs-server:8080/VirtualRadar/AircraftList.json"
export GODAR_SERVER_USERNAME="myuser"      # Optional: HTTP Basic Auth username
export GODAR_SERVER_PASSWORD="mypassword"  # Optional: HTTP Basic Auth password
export GODAR_FILTERS_AIRCRAFT_TYPE="A320"
export GODAR_FILTERS_MIN_ALTITUDE="10000"
export GODAR_FILTERS_MAX_ALTITUDE="40000"
export GODAR_FILTERS_MILITARY="false"
export GODAR_LOCATION_LATITUDE="51.5074"
export GODAR_LOCATION_LONGITUDE="-0.1278"
export GODAR_LOCATION_MAX_DISTANCE="100.0"
export GODAR_MONITORING_POLL_INTERVAL="10s"
export GODAR_NOTIFICATION_ENABLED="true"
export GODAR_NOTIFICATION_DURATION="30s"  # How long notifications are displayed
export GODAR_NOTIFICATION_NOTIFY_ON_CLOSER_ONLY="true"  # Only notify when aircraft get closer (default: true)
export GODAR_NOTIFICATION_RE_NOTIFY_AFTER="5m"          # Re-notify after this time
export GODAR_NOTIFICATION_CLEANUP_INTERVAL="10m"        # Cleanup interval
```

## Aircraft Tracking and Notification Filtering

Godar includes intelligent aircraft tracking to reduce notification spam and only alert you when aircraft are getting closer to your location.

### How It Works

- **Distance Tracking**: Godar tracks the distance of each aircraft over time
- **Closer-Only Notifications**: When enabled, only sends notifications when aircraft are getting closer to your location
- **Re-notification**: Can re-notify about aircraft after a configurable time interval, even if they're not getting closer
- **Automatic Cleanup**: Removes old aircraft from tracking history to prevent memory bloat

### Configuration Options

```yaml
notification:
  enabled: true
  notify_on_closer_only: true    # Only notify when aircraft get closer (default: true)
  re_notify_after: "5m"          # Re-notify after 5 minutes even if not closer
  cleanup_interval: "10m"        # Clean up old aircraft every 10 minutes
```

### Use Cases

- **`notify_on_closer_only: true`** (default): Perfect for spotting aircraft approaching your location
- **`notify_on_closer_only: false`**: Original behavior - notify about all aircraft
- **`re_notify_after: "5m"`**: Useful for long-term monitoring where you want periodic updates
- **`cleanup_interval: "10m"`**: Balances memory usage with tracking accuracy

### Aircraft Identification

Godar uses the following priority for aircraft identification:
1. **ICAO code** (most reliable, unique per aircraft)
2. **Callsign** (flight number, may change)
3. **Type + Altitude** (fallback for unidentified aircraft)

## Usage

### Basic Usage

Start monitoring (all filtering is performed server-side):

```bash
./godar monitor
```

### Configuration-driven Filtering

Set your desired filters in the config file or environment variables. For example, to monitor only military aircraft above 20,000 feet, set:

```yaml
filters:
  military: true
  min_altitude: 20000
```

or

```bash
export GODAR_FILTERS_MILITARY="true"
export GODAR_FILTERS_MIN_ALTITUDE="20000"
```

### Location-Based Monitoring

To monitor aircraft within 50km of London, set:

```yaml
location:
  latitude: 51.5074
  longitude: -0.1278
  max_distance: 50.0
```

or

```bash
export GODAR_LOCATION_LATITUDE="51.5074"
export GODAR_LOCATION_LONGITUDE="-0.1278"
export GODAR_LOCATION_MAX_DISTANCE="50.0"
```

### Custom Polling Interval

To poll every 5 seconds:

```yaml
monitoring:
  poll_interval: "5s"
```

or

```bash
export GODAR_MONITORING_POLL_INTERVAL="5s"
```

## Aircraft Images in Notifications

Godar automatically fetches and displays aircraft images in desktop notifications. The system:

- **Searches by registration**: Tries to find specific aircraft photos using the callsign
- **Falls back to type**: Uses generic aircraft type images when specific ones aren't available
- **Caches images locally**: Stores images in `~/.cache/godar/images/` to avoid repeated downloads
- **Supports common types**: A320, A321, A330, A350, A380, B737, B747, B777, B787, E190, E195
- **Enhanced military support**: Specialized search for military aircraft with multiple search strategies

### Supported Aircraft Types

#### Commercial Aircraft
- **Airbus**: A320, A321, A330, A350, A380
- **Boeing**: B737, B747, B777, B787
- **Embraer**: E190, E195

#### Military Aircraft
Godar includes enhanced support for military aircraft with specialized search strategies:

**US Military Aircraft:**
- **Fighters**: F-16 Fighting Falcon, F-15 Eagle, F/A-18 Hornet, F-22 Raptor, F-35 Lightning II, F-14 Tomcat, F-4 Phantom II, F-5 Tiger II, F-117 Nighthawk
- **Attack**: A-10 Thunderbolt II
- **Bombers**: B-1 Lancer, B-2 Spirit, B-52 Stratofortress, B-21 Raider
- **Transport**: C-130 Hercules, C-17 Globemaster III, C-5 Galaxy
- **Tankers**: KC-135 Stratotanker, KC-10 Extender
- **Special Mission**: E-3 Sentry, E-4 Nightwatch, P-3 Orion, P-8 Poseidon, U-2 Dragon Lady, SR-71 Blackbird

**European Military Aircraft:**
- **Fighters**: Eurofighter Typhoon (EF-2000), Dassault Rafale, Saab JAS 39 Gripen, Panavia Tornado, Harrier Jump Jet, BAE Hawk

**Russian Military Aircraft:**
- **Fighters**: Sukhoi Su-27/30/35/57, Mikoyan MiG-29/31
- **Bombers**: Tupolev Tu-95/160
- **Transport**: Ilyushin Il-76

**Helicopters:**
- **Attack**: AH-64 Apache, AH-1 Cobra, Kamov Ka-52, Mil Mi-24/28
- **Transport**: UH-60 Black Hawk, CH-47 Chinook, V-22 Osprey

### Military Aircraft Detection

The system automatically detects military aircraft based on:
- **Prefix patterns**: F-, A-, B-, C-, E-, P-, KC-, U-, SR-, F/A-
- **Manufacturer codes**: Su, MiG, Tu, Il, Ka, Mi
- **European types**: EF, Rafale, Gripen, Tornado, Harrier, Hawk, Typhoon
- **Helicopter codes**: AH-, UH-, CH-, V-

When a military aircraft is detected, the system uses enhanced search strategies:
- **Multiple search terms**: Tries various naming conventions (F-16, F16, General Dynamics F-16)
- **Partial matching**: Handles variations in aircraft type codes
- **Fallback strategies**: Attempts different search approaches if the first fails

### Image Sources

- **Wikimedia Commons**: Free aircraft images from the Wikimedia database
- **Automatic mapping**: Common aircraft type codes are mapped to full names (A320 ‚Üí Airbus A320)
- **Enhanced military search**: Specialized search strategies for military aircraft with multiple naming variations

### Image Caching

Images are automatically downloaded and cached in `~/.cache/godar/images/`:
- Registration-based: `G-ABCD.jpg` (for specific aircraft)
- Type-based: `type_A320.jpg` (for aircraft types)
- Military aircraft: `type_F16.jpg` (for military types)

To clear the image cache:
```bash
rm -rf ~/.cache/godar/images/
```

## Running as a Systemd User Service

You can run Godar as a systemd user service for automatic startup and background operation.

### Installation

1. **Install the binary:**
   ```bash
   mkdir -p ~/.local/bin
   cp godar ~/.local/bin/
   chmod +x ~/.local/bin/godar
   ```

2. **Create configuration directory and file:**
   ```bash
   mkdir -p ~/.config/godar
   cp godar.yaml ~/.config/godar/
   # Edit the config file with your settings
   nano ~/.config/godar/godar.yaml
   ```

3. **Install the user service:**
   ```bash
   mkdir -p ~/.config/systemd/user
   cp godar.service ~/.config/systemd/user/
   ```

4. **Enable and start the service:**
   ```bash
   systemctl --user daemon-reload
   systemctl --user enable godar
   systemctl --user start godar
   ```

### Service Management

```bash
# Check status
systemctl --user status godar

# View logs
journalctl --user -u godar -f

# Stop/start/restart
systemctl --user stop godar
systemctl --user start godar
systemctl --user restart godar

# Enable/disable auto-start
systemctl --user enable godar
systemctl --user disable godar
```

### Service Features

- **Automatic restart** on failure
- **User-level operation** (no sudo required)
- **Automatic startup** when you log in
- **Logging** to user journal
- **Network dependency** (waits for network)

## Command-Line Options

The CLI now provides a single main command:

| Command | Description |
|---------|-------------|
| `monitor` | Start monitoring aircraft using the configuration file and environment variables |

All filtering and options are set via config or environment variables, not CLI flags.

## Development

### Running Tests

```bash
make test
```

### Linting

```bash
make lint
```

### Building

```bash
make build
```

### Cleaning

```bash
make clean
```

## Project Structure

```
godar/
‚îú‚îÄ‚îÄ cmd/                    # Command-line interface
‚îÇ   ‚îú‚îÄ‚îÄ root.go            # Root command
‚îÇ   ‚îî‚îÄ‚îÄ monitor.go         # Monitor command
‚îú‚îÄ‚îÄ pkg/                   # Application packages
‚îÇ   ‚îú‚îÄ‚îÄ aircraft/          # Aircraft data types
‚îÇ   ‚îú‚îÄ‚îÄ config/            # Configuration management
‚îÇ   ‚îú‚îÄ‚îÄ fetch/             # HTTP client and data fetching
‚îÇ   ‚îú‚îÄ‚îÄ logger/            # Structured logging
‚îÇ   ‚îú‚îÄ‚îÄ monitor/           # Monitoring service
‚îÇ   ‚îî‚îÄ‚îÄ notification/      # Notification handling with image support
‚îú‚îÄ‚îÄ main.go                # Application entry point
‚îú‚îÄ‚îÄ go.mod                 # Go module file
‚îú‚îÄ‚îÄ go.sum                 # Go module checksums
‚îú‚îÄ‚îÄ Makefile               # Build automation
‚îú‚îÄ‚îÄ godar.yaml.example     # Example configuration file
‚îú‚îÄ‚îÄ godar.service          # Systemd user service
‚îú‚îÄ‚îÄ LICENSE                # MIT License
‚îî‚îÄ‚îÄ README.md              # This file
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- [Virtual Radar Server](http://www.virtualradarserver.co.uk/) for providing the aircraft data API
- [Wikimedia Commons](https://commons.wikimedia.org/) for aircraft images
- [Cobra](https://github.com/spf13/cobra) for the CLI framework
- [Viper](https://github.com/spf13/viper) for configuration management
- [Zap](https://github.com/uber-go/zap) for structured logging
